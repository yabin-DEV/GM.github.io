<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>GM选品助手</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>GM选品助手</h1>

    <div style="margin-bottom: 20px;">
      <button onclick="switchPage('form')">选品问答</button>
      <button onclick="switchPage('upload')">上传 Excel</button>
    </div>

    <div id="formPage" style="display: block;">
      <div class="chat-box" id="chatBox"></div>

      <form id="selectionForm">
        <label>销售站点：
          <select id="market">
            <option value="美国" selected>🇺🇸 美国</option>
            <option value="日本">🇯🇵 日本</option>
            <option value="德国">🇩🇪 德国</option>
          </select>
        </label>

        <label>单品采购成本范围（美元）：
          <input type="number" id="costMin" value="50" placeholder="最小值">
          <input type="number" id="costMax" value="100" placeholder="最大值">
        </label>

        <label>期望利润率范围（%）：
          <input type="number" id="profitMin" value="20" placeholder="最小%">
          <input type="number" id="profitMax" placeholder="最大%">
        </label>

        <label>销售节奏：
          <select id="salesSpeed">
            <option value="短期爆量">❶ 短期爆量</option>
            <option value="长期稳定" selected>❷ 长期稳定</option>
          </select>
        </label>

        <label>偏好类目（可多选）：
          <select id="category" multiple size="5">
            <option value="家居" selected>家居</option>
            <option value="宠物">宠物</option>
            <option value="厨房">厨房</option>
            <option value="数码">数码</option>
            <option value="户外">户外</option>
          </select>
        </label>

        <label>仓储和发货方式：
          <select id="shipping">
            <option value="FBA">❶ FBA</option>
            <option value="自发货" selected>❷ 自发货</option>
            <option value="海外仓">❸ 海外仓</option>
          </select>
        </label>

        <label>结合社媒趋势判断：
          <select id="social">
            <option value="是" selected>是</option>
            <option value="否">否</option>
          </select>
        </label>

        <button type="button" onclick="sendForm()">发送</button>
      </form>
    </div>

    <div id="uploadPage" style="display: none;">
      <h2>📊 批量上传知识数据（Excel）</h2>
      <input type="file" id="excelInput" accept=".xlsx, .xls" />
      <div id="log" style="white-space: pre-wrap; margin-top: 10px; color: green;"></div>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://divine-silence-bb95.zhangyabin2000618.workers.dev/";

    function switchPage(page) {
      document.getElementById("formPage").style.display = (page === 'form') ? 'block' : 'none';
      document.getElementById("uploadPage").style.display = (page === 'upload') ? 'block' : 'none';
    }

    function sendForm() {
      const message = `
销售站点：${document.getElementById("market").value}
成本范围：$${document.getElementById("costMin").value} ~ $${document.getElementById("costMax").value}
利润率范围：${document.getElementById("profitMin").value}% ~ ${document.getElementById("profitMax").value || "未填"}%
销售节奏：${document.getElementById("salesSpeed").value}
偏好类目：${[...document.getElementById("category").selectedOptions].map(o => o.value).join(", ")}
仓储方式：${document.getElementById("shipping").value}
社媒趋势判断：${document.getElementById("social").value}
`;

      fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      })
        .then(res => res.json())
        .then(data => {
          const box = document.getElementById("chatBox");
          box.innerText = data.reply || data.error || "无响应";
        })
        .catch(err => {
          document.getElementById("chatBox").innerText = "❌ 请求出错：" + err.message;
        });
    }

    // ✅ Excel 上传逻辑（带错误捕捉 + 状态提示）
    document.getElementById("excelInput").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      const log = document.getElementById("log");
      log.style.color = "#000";
      log.textContent = "";

      if (!file) {
        log.style.color = "red";
        log.textContent = "❌ 没有选择文件";
        return;
      }

      log.textContent = "📤 正在解析并上传，请稍候...\n";

      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          // Using header: 1 to get an array of arrays, then manually handle column names.
          // IMPORTANT: If your first row is the header, you should use `rows[0]` for `headers`.
          // If your *second* row is the header, then `rows[1]` is correct.
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (!rows || rows.length <= 1) { // Checks if there's at least a header row + one data row
            log.style.color = "red";
            log.textContent += "❌ 表格中没有有效数据行。\n";
            return;
          }

          // Get headers. Assuming the first row (index 0) is the actual header row.
          const headers = rows[0]; // Changed from rows[1] to rows[0] based on standard Excel format
          const uploadResults = [];
          let successCount = 0;

          // Start iterating from the first data row (index 1), skipping the header row
          for (let i = 1; i < rows.length; i++) {
            const rowData = rows[i];
            const rowText = rowData.join(" | ").trim(); // Keep original row text for vectorization

            if (!rowText) {
              uploadResults.push(`⚠️ 第 ${i} 行数据为空，跳过`);
              continue;
            }

            // Map row data to Weaviate properties
            const weaviateProperties = {};
            // Iterate through headers, mapping data to corresponding property names
            headers.forEach((header, index) => {
              let value = rowData[index];
              const weaviatePropertyName = mapHeaderToWeaviateProperty(header); // Get the cleaned property name

              // Skip if the property name is invalid or empty after mapping
              if (!weaviatePropertyName) {
                  console.warn(`Skipping column '${header}' as its mapped Weaviate property name is invalid or empty.`);
                  return; // Skip this iteration of forEach
              }

              // Type conversion based on the *cleaned* Weaviate property name
              switch (weaviatePropertyName) {
                case "weeklySearchVolume":
                case "currentRank":
                case "impressions":
                case "clicks":
                case "spr":
                case "titleDensity":
                  weaviateProperties[weaviatePropertyName] = parseInt(value) || 0; // Convert to integer, 0 if invalid
                  break;
                case "ppcPrice":
                  weaviateProperties[weaviatePropertyName] = parseFloat(String(value || '').replace('$', '')) || 0.0; // Remove '$' and convert to float
                  break;
                default:
                  weaviateProperties[weaviatePropertyName] = String(value || ''); // Ensure it's a string
              }
            });

            // Add original row content as the main content for vectorization
            weaviateProperties.fullRowContent = rowText;

            try {
              const res = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  action: "upload",
                  content: rowText, // Still send original row text for worker to generate vector
                  source: file.name,
                  category: weaviateProperties.category || sheetName, // Use parsed category, else sheetName
                  properties: weaviateProperties // New: Send structured property data
                })
              });

              const result = await res.json();

              if (!res.ok || result.error) {
                uploadResults.push(`❌ 第 ${i} 行上传失败：${result.error || "未知错误"}`);
              } else {
                uploadResults.push(`✅ 第 ${i} 行上传成功`);
                successCount++;
              }
            } catch (err) {
              uploadResults.push(`❌ 第 ${i} 行请求异常：${err.message}`);
            }
          }

          log.innerHTML = `
            📦 文件名：${file.name}
            📑 表格行数：${rows.length - 1}
            ✅ 成功上传：${successCount}
            ❌ 失败行数：${rows.length - 1 - successCount}
            \n\n${uploadResults.join("\n")}
          `.trim();

          log.scrollIntoView({ behavior: "smooth" });

        } catch (err) {
          log.style.color = "red";
          log.textContent = `❌ 文件解析失败：${err.message}`;
        }
      };

      reader.onerror = () => {
        log.style.color = "red";
        log.textContent = "❌ 文件读取失败，请重试";
      };

      reader.readAsArrayBuffer(file);
    });

    // ✅ Helper function: map Excel header to a valid Weaviate property name
    // This is the robust version that handles Chinese characters and GraphQL naming rules.
    function mapHeaderToWeaviateProperty(header) {
      const trimmedHeader = header.trim();

      switch (trimmedHeader) {
        case "关键词": return "keyword";
        case "关键词翻译": return "keywordTranslation";
        case "周搜索量": return "weeklySearchVolume";
        case "现排名": return "currentRank";
        case "历史排名": return "historyRank";
        case "周变化量": return "weeklyChangeAmount";
        case "周变化率": return "weeklyChangeRate";
        case "PPC价格": return "ppcPrice";
        case "建议竞价范围": return "suggestedBidRange";
        case "展示量": return "impressions";
        case "点击量": return "clicks";
        case "SPR": return "spr";
        case "标题密度": return "titleDensity";
        case "点击集中度": return "clickConcentration";
        case "转化集中度": return "conversionConcentration";
        case "点击前三ASIN": return "top3Asin";
        case "点击前三品牌": return "top3Brand";
        case "所属类目": return "category";
        case "完整行内容": return "fullRowContent";
        case "来源": return "source";
        default:
          // Fallback for unexpected headers: clean aggressively
          let cleanedName = trimmedHeader
            .replace(/[^\w\s]/g, '') // Remove non-word characters (includes punctuation, special symbols)
            .replace(/\s+/g, '_')   // Replace spaces with underscores
            .replace(/^_|_$/g, '')  // Remove leading/trailing underscores from replacements
            .toLowerCase();         // Convert to lower case for consistency

          // Prepend underscore if it starts with a number
          if (/^\d/.test(cleanedName)) {
            cleanedName = '_' + cleanedName;
          }

          // Ensure it's not empty and starts with a letter/underscore
          if (cleanedName.length === 0) {
            console.warn(`Original header '${header}' resulted in an empty property name.`);
            return null; // Indicate invalid property name
          }
          if (!/^[a-z_]/.test(cleanedName)) {
            cleanedName = '_' + cleanedName;
          }
          return cleanedName;
      }
    }
  </script>
</body>
</html>