<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMé€‰å“åŠ©æ‰‹</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>GMé€‰å“åŠ©æ‰‹</h1>
            <div class="page-switcher">
                <button class="active" onclick="switchPage('form')">é€‰å“é—®ç­”</button>
                <button onclick="switchPage('upload')">ä¸Šä¼  Excel</button>
            </div>
        </header>

        <main class="app-content">
            <section id="formPage" class="page-section active">
                <div class="chat-box" id="chatBox">
                    <p class="welcome-message">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨äºšé©¬é€Šè“æµ·é€‰å“åŠ©æ‰‹ï¼æˆ‘å°†é€šè¿‡ä¸“ä¸šé€‰å“å·¥å…·å’Œè¶‹åŠ¿æ•°æ®ï¼ˆåŒ…æ‹¬Amazonã€TikTokã€Googleã€Pinterestç­‰ï¼‰ä¸ºä½ æŒ–æ˜é«˜åˆ©æ¶¦ã€ä½ç«äº‰ã€è¶‹åŠ¿å‘ä¸Šçš„äº§å“æœºä¼šã€‚</p>
                    <p class="welcome-message">åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘éœ€è¦äº†è§£ä»¥ä¸‹ä¿¡æ¯ï¼Œä»¥ä¾¿ä¸ºä½ å®šåˆ¶æœ€é€‚åˆçš„é€‰å“ç­–ç•¥ğŸ‘‡</p>
                </div>

                <form id="selectionForm" class="selection-form">
                    <div class="form-group">
                        <label for="market">é”€å”®ç«™ç‚¹ï¼š</label>
                        <select id="market" class="form-select">
                            <option value="ç¾å›½" selected>ğŸ‡ºğŸ‡¸ ç¾å›½</option>
                            <option value="æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                            <option value="å¾·å›½">ğŸ‡©ğŸ‡ª å¾·å›½</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å•å“é‡‡è´­æˆæœ¬èŒƒå›´ï¼ˆç¾å…ƒï¼‰ï¼š</label>
                        <div class="input-group">
                            <input type="number" id="costMin" value="50" placeholder="æœ€å°å€¼" class="form-input">
                            <span class="input-separator">~</span>
                            <input type="number" id="costMax" value="100" placeholder="æœ€å¤§å€¼" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æœŸæœ›åˆ©æ¶¦ç‡èŒƒå›´ï¼ˆ%ï¼‰ï¼š</label>
                        <div class="input-group">
                            <input type="number" id="profitMin" value="20" placeholder="æœ€å°%" class="form-input">
                            <span class="input-separator">~</span>
                            <input type="number" id="profitMax" placeholder="æœ€å¤§%" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="salesSpeed">é”€å”®èŠ‚å¥ï¼š</label>
                        <select id="salesSpeed" class="form-select">
                            <option value="çŸ­æœŸçˆ†é‡">â¶ çŸ­æœŸçˆ†é‡</option>
                            <option value="é•¿æœŸç¨³å®š" selected>â· é•¿æœŸç¨³å®š</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">åå¥½ç±»ç›®ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</label>
                        <select id="category" multiple size="5" class="form-select multiple-select">
                            <option value="å®¶å±…" selected>å®¶å±…</option>
                            <option value="å® ç‰©">å® ç‰©</option>
                            <option value="å¨æˆ¿">å¨æˆ¿</option>
                            <option value="æ•°ç ">æ•°ç </option>
                            <option value="æˆ·å¤–">æˆ·å¤–</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="shipping">ä»“å‚¨å’Œå‘è´§æ–¹å¼ï¼š</label>
                        <select id="shipping" class="form-select">
                            <option value="FBA">â¶ FBA</option>
                            <option value="è‡ªå‘è´§" selected>â· è‡ªå‘è´§</option>
                            <option value="æµ·å¤–ä»“">â¸ æµ·å¤–ä»“</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="social">ç»“åˆç¤¾åª’è¶‹åŠ¿åˆ¤æ–­ï¼š</label>
                        <select id="social" class="form-select">
                            <option value="æ˜¯" selected>æ˜¯</option>
                            <option value="å¦">å¦</option>
                        </select>
                    </div>

                    <button type="button" onclick="sendForm()" class="submit-button">ç”Ÿæˆé€‰å“æŠ¥å‘Š</button>
                </form>
            </section>

            <section id="uploadPage" class="page-section">
                <h2>ğŸ“Š æ‰¹é‡ä¸Šä¼ çŸ¥è¯†æ•°æ®ï¼ˆExcelï¼‰</h2>
                <div class="upload-area">
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="file-input"/>
                    <label for="excelInput" class="file-input-label">é€‰æ‹© Excel æ–‡ä»¶</label>
                </div>
                <div id="log" class="upload-log"></div>
            </section>
        </main>
    </div>

    <script>
        const WORKER_URL = "https://divine-silence-bb95.zhangyabin2000618.workers.dev/";

        function switchPage(page) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(page + 'Page').classList.add('active');

            document.querySelectorAll('.page-switcher button').forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active'); // Add active class to the clicked button
        }

        // Function to append message to chatBox (for clarity and reusability)
        function appendMessage(sender, text, isError = false) {
            const chatBox = document.getElementById("chatBox");
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);
            if (isError) {
                messageElement.classList.add("error");
            }

            // Simple Markdown rendering for bold, links, tables, etc.
            // For production, consider a dedicated Markdown parser library if complex markdown is expected.
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'); // Links

            // Basic table parsing (very simplified, for full tables, you'd need a more robust parser)
            if (formattedText.includes('|---')) {
                formattedText = parseMarkdownTableToHtml(formattedText);
            }

            messageElement.innerHTML = formattedText;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        }

        // --- Simplified Markdown Table Parser (for demonstration) ---
        // This is a basic example. For robust table parsing, consider a library.
        function parseMarkdownTableToHtml(markdown) {
            const lines = markdown.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return markdown; // Not a valid table

            let html = '<table>';

            // Headers
            const headerLine = lines[0].trim();
            const headerCells = headerLine.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
            if (headerCells.length > 0) {
                html += '<thead><tr>';
                headerCells.forEach(cell => {
                    html += `<th>${cell}</th>`;
                });
                html += '</tr></thead>';
            }

            // Content (skip separator line and headers)
            if (lines.length > 2) {
                html += '<tbody>';
                for (let i = 2; i < lines.length; i++) {
                    const dataLine = lines[i].trim();
                    const dataCells = dataLine.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
                    if (dataCells.length === headerCells.length) { // Ensure cell count matches header
                        html += '<tr>';
                        dataCells.forEach(cell => {
                            html += `<td>${cell}</td>`;
                        });
                        html += '</tr>';
                    }
                }
                html += '</tbody>';
            }

            html += '</table>';
            return html;
        }


        async function sendForm() {
            const market = document.getElementById("market").value;
            const costMin = document.getElementById("costMin").value;
            const costMax = document.getElementById("costMax").value;
            const profitMin = document.getElementById("profitMin").value;
            const profitMax = document.getElementById("profitMax").value || "æœªè®¾å®šä¸Šé™";
            const salesSpeed = document.getElementById("salesSpeed").value;
            const selectedCategories = [...document.getElementById("category").selectedOptions].map(o => o.value).join(", ");
            const shipping = document.getElementById("shipping").value;
            const social = document.getElementById("social").value;

            const userMessage = `
é”€å”®ç«™ç‚¹ï¼š${market}
æˆæœ¬èŒƒå›´ï¼š$${costMin} ~ $${costMax}
åˆ©æ¶¦ç‡èŒƒå›´ï¼š${profitMin}% ~ ${profitMax}%
é”€å”®èŠ‚å¥ï¼š${salesSpeed}
åå¥½ç±»ç›®ï¼š${selectedCategories}
ä»“å‚¨æ–¹å¼ï¼š${shipping}
ç¤¾åª’è¶‹åŠ¿åˆ¤æ–­ï¼š${social}
`;
            appendMessage("user", userMessage); // Display user's message

            appendMessage("ai", "æ­£åœ¨ç”Ÿæˆé€‰å“æŠ¥å‘Šï¼Œè¯·ç¨å€™...", false, true); // Loading message

            try {
                const res = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userMessage })
                });

                const data = await res.json();
                const chatBox = document.getElementById("chatBox");
                // Remove loading message
                if (chatBox.lastChild && chatBox.lastChild.classList.contains("loading-message")) {
                    chatBox.removeChild(chatBox.lastChild);
                }

                if (!res.ok || data.error) {
                    appendMessage("ai", data.error || "æœªçŸ¥é”™è¯¯", true);
                } else {
                    appendMessage("ai", data.reply || "æ— å“åº”");
                }
            } catch (err) {
                const chatBox = document.getElementById("chatBox");
                if (chatBox.lastChild && chatBox.lastChild.classList.contains("loading-message")) {
                    chatBox.removeChild(chatBox.lastChild);
                }
                appendMessage("ai", "âŒ è¯·æ±‚å‡ºé”™ï¼š" + err.message, true);
            }
        }

        // Helper for loading message
        function appendMessage(sender, text, isError = false, isLoading = false) {
            const chatBox = document.getElementById("chatBox");
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);
            if (isError) {
                messageElement.classList.add("error");
            }
            if (isLoading) {
                messageElement.classList.add("loading-message");
                messageElement.innerHTML = `<span class="loading-spinner"></span> ${text}`;
            } else {
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\[(.*?)\]\((https?:\/\/[^\s\]]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

                if (formattedText.includes('|---')) {
                    formattedText = parseMarkdownTableToHtml(formattedText);
                }
                messageElement.innerHTML = formattedText;
            }
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // âœ… Excel ä¸Šä¼ é€»è¾‘ï¼ˆå¸¦é”™è¯¯æ•æ‰ + çŠ¶æ€æç¤ºï¼‰
        document.getElementById("excelInput").addEventListener("change", async (event) => {
            const file = event.target.files[0];
            const log = document.getElementById("log");
            log.style.color = "#4a4a4a"; // Default text color for logs
            log.textContent = "";

            if (!file) {
                log.style.color = "var(--color-error)";
                log.textContent = "âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶";
                return;
            }

            log.textContent = "ğŸ“¤ æ­£åœ¨è§£æå¹¶ä¸Šä¼ ï¼Œè¯·ç¨å€™...\n";
            log.classList.remove('error'); // Clear previous error state

            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });

                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (!rows || rows.length <= 1) {
                        log.style.color = "var(--color-error)";
                        log.textContent += "âŒ è¡¨æ ¼ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¡Œã€‚\n";
                        return;
                    }

                    const headers = rows[0];
                    const uploadResults = [];
                    let successCount = 0;
                    let failureCount = 0;

                    for (let i = 1; i < rows.length; i++) {
                        const rowData = rows[i];
                        const rowText = rowData.join(" | ").trim();

                        if (!rowText) {
                            uploadResults.push(`âš ï¸ ç¬¬ ${i} è¡Œæ•°æ®ä¸ºç©ºï¼Œè·³è¿‡`);
                            continue;
                        }

                        const weaviateProperties = {};
                        headers.forEach((header, index) => {
                            let value = rowData[index];
                            const weaviatePropertyName = mapHeaderToWeaviateProperty(header);

                            if (!weaviatePropertyName) {
                                console.warn(`Skipping column '${header}' as its mapped Weaviate property name is invalid or empty.`);
                                return;
                            }

                            switch (weaviatePropertyName) {
                                case "weeklySearchVolume":
                                case "currentRank":
                                case "impressions":
                                case "clicks":
                                case "spr":
                                case "titleDensity":
                                    weaviateProperties[weaviatePropertyName] = parseInt(value) || 0;
                                    break;
                                case "ppcPrice":
                                    weaviateProperties[weaviatePropertyName] = parseFloat(String(value || '').replace('$', '')) || 0.0;
                                    break;
                                default:
                                    weaviateProperties[weaviatePropertyName] = String(value || '');
                            }
                        });

                        weaviateProperties.fullRowContent = rowText;

                        try {
                            const res = await fetch(WORKER_URL, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    action: "upload",
                                    content: rowText,
                                    source: file.name,
                                    category: weaviateProperties.category || sheetName,
                                    properties: weaviateProperties
                                })
                            });

                            const result = await res.json();

                            if (!res.ok || result.error) {
                                uploadResults.push(`âŒ ç¬¬ ${i} è¡Œä¸Šä¼ å¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`);
                                failureCount++;
                            } else {
                                uploadResults.push(`âœ… ç¬¬ ${i} è¡Œä¸Šä¼ æˆåŠŸ`);
                                successCount++;
                            }
                        } catch (err) {
                            uploadResults.push(`âŒ ç¬¬ ${i} è¡Œè¯·æ±‚å¼‚å¸¸ï¼š${err.message}`);
                            failureCount++;
                        }
                    }

                    log.innerHTML = `
                        <p><strong>ğŸ“¦ æ–‡ä»¶åï¼š</strong>${file.name}</p>
                        <p><strong>ğŸ“‘ è¡¨æ ¼è¡Œæ•°ï¼š</strong>${rows.length - 1}</p>
                        <p style="color: var(--color-success);"><strong>âœ… æˆåŠŸä¸Šä¼ ï¼š</strong>${successCount}</p>
                        <p style="color: var(--color-error);"><strong>âŒ å¤±è´¥è¡Œæ•°ï¼š</strong>${failureCount}</p>
                        <div class="upload-detail-log">
                            <h3>ä¸Šä¼ è¯¦æƒ…:</h3>
                            ${uploadResults.map(msg => `<p>${msg}</p>`).join("")}
                        </div>
                    `;

                    log.scrollIntoView({ behavior: "smooth" });

                } catch (err) {
                    log.style.color = "var(--color-error)";
                    log.textContent = `âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š${err.message}`;
                }
            };

            reader.onerror = () => {
                log.style.color = "var(--color-error)";
                log.textContent = "âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•";
            };

            reader.readAsArrayBuffer(file);
        });

        // âœ… Helper function: map Excel header to a valid Weaviate property name
        function mapHeaderToWeaviateProperty(header) {
            const trimmedHeader = header.trim();

            switch (trimmedHeader) {
                case "å…³é”®è¯": return "keyword";
                case "å…³é”®è¯ç¿»è¯‘": return "keywordTranslation";
                case "å‘¨æœç´¢é‡": return "weeklySearchVolume";
                case "ç°æ’å": return "currentRank";
                case "å†å²æ’å": return "historyRank";
                case "å‘¨å˜åŒ–é‡": return "weeklyChangeAmount";
                case "å‘¨å˜åŒ–ç‡": return "weeklyChangeRate";
                case "PPCä»·æ ¼": return "ppcPrice";
                case "å»ºè®®ç«ä»·èŒƒå›´": return "suggestedBidRange";
                case "å±•ç¤ºé‡": return "impressions";
                case "ç‚¹å‡»é‡": return "clicks";
                case "SPR": return "spr";
                case "æ ‡é¢˜å¯†åº¦": return "titleDensity";
                case "ç‚¹å‡»é›†ä¸­åº¦": return "clickConcentration";
                case "è½¬åŒ–é›†ä¸­åº¦": return "conversionConcentration";
                case "ç‚¹å‡»å‰ä¸‰ASIN": return "top3Asin";
                case "ç‚¹å‡»å‰ä¸‰å“ç‰Œ": return "top3Brand";
                case "æ‰€å±ç±»ç›®": return "category";
                case "å®Œæ•´è¡Œå†…å®¹": return "fullRowContent";
                case "æ¥æº": return "source";
                default:
                    let cleanedName = trimmedHeader
                        .replace(/[^\w\s]/g, '')
                        .replace(/\s+/g, '_')
                        .replace(/^_|_$/g, '')
                        .toLowerCase();

                    if (/^\d/.test(cleanedName)) {
                        cleanedName = '_' + cleanedName;
                    }

                    if (cleanedName.length === 0) {
                        console.warn(`Original header '${header}' resulted in an empty property name.`);
                        return null;
                    }
                    if (!/^[a-z_]/.test(cleanedName)) {
                        cleanedName = '_' + cleanedName;
                    }
                    return cleanedName;
            }
        }
    </script>
</body>
</html>