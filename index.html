<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM选品助手</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>GM选品助手</h1>
            <div class="page-switcher">
                <button class="active" onclick="switchPage('form')">选品问答</button>
                <button onclick="switchPage('upload')">上传 Excel</button>
            </div>
        </header>

        <main class="app-content">
            <section id="formPage" class="page-section active">
                <div class="chat-box" id="chatBox">
                    <p class="welcome-message">👋 欢迎使用亚马逊蓝海选品助手！我将通过专业选品工具和趋势数据（包括Amazon、TikTok、Google、Pinterest等）为你挖掘高利润、低竞争、趋势向上的产品机会。</p>
                    <p class="welcome-message">在开始之前，我需要了解以下信息，以便为你定制最适合的选品策略👇</p>
                </div>

                <form id="selectionForm" class="selection-form">
                    <div class="form-group">
                        <label for="market">销售站点：</label>
                        <select id="market" class="form-select">
                            <option value="美国" selected>🇺🇸 美国</option>
                            <option value="日本">🇯🇵 日本</option>
                            <option value="德国">🇩🇪 德国</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>单品采购成本范围（美元）：</label>
                        <div class="input-group">
                            <input type="number" id="costMin" value="50" placeholder="最小值" class="form-input">
                            <span class="input-separator">~</span>
                            <input type="number" id="costMax" value="100" placeholder="最大值" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>期望利润率范围（%）：</label>
                        <div class="input-group">
                            <input type="number" id="profitMin" value="20" placeholder="最小%" class="form-input">
                            <span class="input-separator">~</span>
                            <input type="number" id="profitMax" placeholder="最大%" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="salesSpeed">销售节奏：</label>
                        <select id="salesSpeed" class="form-select">
                            <option value="短期爆量">❶ 短期爆量</option>
                            <option value="长期稳定" selected>❷ 长期稳定</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">偏好类目（可多选）：</label>
                        <select id="category" multiple size="5" class="form-select multiple-select">
                            <option value="家居" selected>家居</option>
                            <option value="宠物">宠物</option>
                            <option value="厨房">厨房</option>
                            <option value="数码">数码</option>
                            <option value="户外">户外</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="shipping">仓储和发货方式：</label>
                        <select id="shipping" class="form-select">
                            <option value="FBA">❶ FBA</option>
                            <option value="自发货" selected>❷ 自发货</option>
                            <option value="海外仓">❸ 海外仓</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="social">结合社媒趋势判断：</label>
                        <select id="social" class="form-select">
                            <option value="是" selected>是</option>
                            <option value="否">否</option>
                        </select>
                    </div>

                    <button type="button" onclick="sendForm()" class="submit-button">生成选品报告</button>
                </form>
            </section>

            <section id="uploadPage" class="page-section">
                <h2>📊 批量上传知识数据（Excel）</h2>
                <div class="upload-area">
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="file-input"/>
                    <label for="excelInput" class="file-input-label">选择 Excel 文件</label>
                </div>
                <div id="log" class="upload-log"></div>
            </section>
        </main>
    </div>

    <script>
        const WORKER_URL = "https://divine-silence-bb95.zhangyabin2000618.workers.dev/";

        function switchPage(page) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(page + 'Page').classList.add('active');

            document.querySelectorAll('.page-switcher button').forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active'); // Add active class to the clicked button
        }

        // Function to append message to chatBox (for clarity and reusability)
        function appendMessage(sender, text, isError = false) {
            const chatBox = document.getElementById("chatBox");
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);
            if (isError) {
                messageElement.classList.add("error");
            }

            // Simple Markdown rendering for bold, links, tables, etc.
            // For production, consider a dedicated Markdown parser library if complex markdown is expected.
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'); // Links

            // Basic table parsing (very simplified, for full tables, you'd need a more robust parser)
            if (formattedText.includes('|---')) {
                formattedText = parseMarkdownTableToHtml(formattedText);
            }

            messageElement.innerHTML = formattedText;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        }

        // --- Simplified Markdown Table Parser (for demonstration) ---
        // This is a basic example. For robust table parsing, consider a library.
        function parseMarkdownTableToHtml(markdown) {
            const lines = markdown.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return markdown; // Not a valid table

            let html = '<table>';

            // Headers
            const headerLine = lines[0].trim();
            const headerCells = headerLine.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
            if (headerCells.length > 0) {
                html += '<thead><tr>';
                headerCells.forEach(cell => {
                    html += `<th>${cell}</th>`;
                });
                html += '</tr></thead>';
            }

            // Content (skip separator line and headers)
            if (lines.length > 2) {
                html += '<tbody>';
                for (let i = 2; i < lines.length; i++) {
                    const dataLine = lines[i].trim();
                    const dataCells = dataLine.split('|').map(cell => cell.trim()).filter(cell => cell !== '');
                    if (dataCells.length === headerCells.length) { // Ensure cell count matches header
                        html += '<tr>';
                        dataCells.forEach(cell => {
                            html += `<td>${cell}</td>`;
                        });
                        html += '</tr>';
                    }
                }
                html += '</tbody>';
            }

            html += '</table>';
            return html;
        }


        async function sendForm() {
            const market = document.getElementById("market").value;
            const costMin = document.getElementById("costMin").value;
            const costMax = document.getElementById("costMax").value;
            const profitMin = document.getElementById("profitMin").value;
            const profitMax = document.getElementById("profitMax").value || "未设定上限";
            const salesSpeed = document.getElementById("salesSpeed").value;
            const selectedCategories = [...document.getElementById("category").selectedOptions].map(o => o.value).join(", ");
            const shipping = document.getElementById("shipping").value;
            const social = document.getElementById("social").value;

            const userMessage = `
销售站点：${market}
成本范围：$${costMin} ~ $${costMax}
利润率范围：${profitMin}% ~ ${profitMax}%
销售节奏：${salesSpeed}
偏好类目：${selectedCategories}
仓储方式：${shipping}
社媒趋势判断：${social}
`;
            appendMessage("user", userMessage); // Display user's message

            appendMessage("ai", "正在生成选品报告，请稍候...", false, true); // Loading message

            try {
                const res = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userMessage })
                });

                const data = await res.json();
                const chatBox = document.getElementById("chatBox");
                // Remove loading message
                if (chatBox.lastChild && chatBox.lastChild.classList.contains("loading-message")) {
                    chatBox.removeChild(chatBox.lastChild);
                }

                if (!res.ok || data.error) {
                    appendMessage("ai", data.error || "未知错误", true);
                } else {
                    appendMessage("ai", data.reply || "无响应");
                }
            } catch (err) {
                const chatBox = document.getElementById("chatBox");
                if (chatBox.lastChild && chatBox.lastChild.classList.contains("loading-message")) {
                    chatBox.removeChild(chatBox.lastChild);
                }
                appendMessage("ai", "❌ 请求出错：" + err.message, true);
            }
        }

        // Helper for loading message
        function appendMessage(sender, text, isError = false, isLoading = false) {
            const chatBox = document.getElementById("chatBox");
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);
            if (isError) {
                messageElement.classList.add("error");
            }
            if (isLoading) {
                messageElement.classList.add("loading-message");
                messageElement.innerHTML = `<span class="loading-spinner"></span> ${text}`;
            } else {
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\[(.*?)\]\((https?:\/\/[^\s\]]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

                if (formattedText.includes('|---')) {
                    formattedText = parseMarkdownTableToHtml(formattedText);
                }
                messageElement.innerHTML = formattedText;
            }
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ✅ Excel 上传逻辑（带错误捕捉 + 状态提示）
        document.getElementById("excelInput").addEventListener("change", async (event) => {
            const file = event.target.files[0];
            const log = document.getElementById("log");
            log.style.color = "#4a4a4a"; // Default text color for logs
            log.textContent = "";

            if (!file) {
                log.style.color = "var(--color-error)";
                log.textContent = "❌ 没有选择文件";
                return;
            }

            log.textContent = "📤 正在解析并上传，请稍候...\n";
            log.classList.remove('error'); // Clear previous error state

            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });

                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (!rows || rows.length <= 1) {
                        log.style.color = "var(--color-error)";
                        log.textContent += "❌ 表格中没有有效数据行。\n";
                        return;
                    }

                    const headers = rows[0];
                    const uploadResults = [];
                    let successCount = 0;
                    let failureCount = 0;

                    for (let i = 1; i < rows.length; i++) {
                        const rowData = rows[i];
                        const rowText = rowData.join(" | ").trim();

                        if (!rowText) {
                            uploadResults.push(`⚠️ 第 ${i} 行数据为空，跳过`);
                            continue;
                        }

                        const weaviateProperties = {};
                        headers.forEach((header, index) => {
                            let value = rowData[index];
                            const weaviatePropertyName = mapHeaderToWeaviateProperty(header);

                            if (!weaviatePropertyName) {
                                console.warn(`Skipping column '${header}' as its mapped Weaviate property name is invalid or empty.`);
                                return;
                            }

                            switch (weaviatePropertyName) {
                                case "weeklySearchVolume":
                                case "currentRank":
                                case "impressions":
                                case "clicks":
                                case "spr":
                                case "titleDensity":
                                    weaviateProperties[weaviatePropertyName] = parseInt(value) || 0;
                                    break;
                                case "ppcPrice":
                                    weaviateProperties[weaviatePropertyName] = parseFloat(String(value || '').replace('$', '')) || 0.0;
                                    break;
                                default:
                                    weaviateProperties[weaviatePropertyName] = String(value || '');
                            }
                        });

                        weaviateProperties.fullRowContent = rowText;

                        try {
                            const res = await fetch(WORKER_URL, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    action: "upload",
                                    content: rowText,
                                    source: file.name,
                                    category: weaviateProperties.category || sheetName,
                                    properties: weaviateProperties
                                })
                            });

                            const result = await res.json();

                            if (!res.ok || result.error) {
                                uploadResults.push(`❌ 第 ${i} 行上传失败：${result.error || "未知错误"}`);
                                failureCount++;
                            } else {
                                uploadResults.push(`✅ 第 ${i} 行上传成功`);
                                successCount++;
                            }
                        } catch (err) {
                            uploadResults.push(`❌ 第 ${i} 行请求异常：${err.message}`);
                            failureCount++;
                        }
                    }

                    log.innerHTML = `
                        <p><strong>📦 文件名：</strong>${file.name}</p>
                        <p><strong>📑 表格行数：</strong>${rows.length - 1}</p>
                        <p style="color: var(--color-success);"><strong>✅ 成功上传：</strong>${successCount}</p>
                        <p style="color: var(--color-error);"><strong>❌ 失败行数：</strong>${failureCount}</p>
                        <div class="upload-detail-log">
                            <h3>上传详情:</h3>
                            ${uploadResults.map(msg => `<p>${msg}</p>`).join("")}
                        </div>
                    `;

                    log.scrollIntoView({ behavior: "smooth" });

                } catch (err) {
                    log.style.color = "var(--color-error)";
                    log.textContent = `❌ 文件解析失败：${err.message}`;
                }
            };

            reader.onerror = () => {
                log.style.color = "var(--color-error)";
                log.textContent = "❌ 文件读取失败，请重试";
            };

            reader.readAsArrayBuffer(file);
        });

        // ✅ Helper function: map Excel header to a valid Weaviate property name
        function mapHeaderToWeaviateProperty(header) {
            const trimmedHeader = header.trim();

            switch (trimmedHeader) {
                case "关键词": return "keyword";
                case "关键词翻译": return "keywordTranslation";
                case "周搜索量": return "weeklySearchVolume";
                case "现排名": return "currentRank";
                case "历史排名": return "historyRank";
                case "周变化量": return "weeklyChangeAmount";
                case "周变化率": return "weeklyChangeRate";
                case "PPC价格": return "ppcPrice";
                case "建议竞价范围": return "suggestedBidRange";
                case "展示量": return "impressions";
                case "点击量": return "clicks";
                case "SPR": return "spr";
                case "标题密度": return "titleDensity";
                case "点击集中度": return "clickConcentration";
                case "转化集中度": return "conversionConcentration";
                case "点击前三ASIN": return "top3Asin";
                case "点击前三品牌": return "top3Brand";
                case "所属类目": return "category";
                case "完整行内容": return "fullRowContent";
                case "来源": return "source";
                default:
                    let cleanedName = trimmedHeader
                        .replace(/[^\w\s]/g, '')
                        .replace(/\s+/g, '_')
                        .replace(/^_|_$/g, '')
                        .toLowerCase();

                    if (/^\d/.test(cleanedName)) {
                        cleanedName = '_' + cleanedName;
                    }

                    if (cleanedName.length === 0) {
                        console.warn(`Original header '${header}' resulted in an empty property name.`);
                        return null;
                    }
                    if (!/^[a-z_]/.test(cleanedName)) {
                        cleanedName = '_' + cleanedName;
                    }
                    return cleanedName;
            }
        }
    </script>
</body>
</html>