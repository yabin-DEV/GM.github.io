<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>GMé€‰å“åŠ©æ‰‹</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>GMé€‰å“åŠ©æ‰‹</h1>

    <div style="margin-bottom: 20px;">
      <button onclick="switchPage('form')">é€‰å“é—®ç­”</button>
      <button onclick="switchPage('upload')">ä¸Šä¼  Excel</button>
    </div>

    <div id="formPage" style="display: block;">
      <div class="chat-box" id="chatBox"></div>

      <form id="selectionForm">
        <label>é”€å”®ç«™ç‚¹ï¼š
          <select id="market">
            <option value="ç¾å›½" selected>ğŸ‡ºğŸ‡¸ ç¾å›½</option>
            <option value="æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
            <option value="å¾·å›½">ğŸ‡©ğŸ‡ª å¾·å›½</option>
          </select>
        </label>

        <label>å•å“é‡‡è´­æˆæœ¬èŒƒå›´ï¼ˆç¾å…ƒï¼‰ï¼š
          <input type="number" id="costMin" value="50" placeholder="æœ€å°å€¼">
          <input type="number" id="costMax" value="100" placeholder="æœ€å¤§å€¼">
        </label>

        <label>æœŸæœ›åˆ©æ¶¦ç‡èŒƒå›´ï¼ˆ%ï¼‰ï¼š
          <input type="number" id="profitMin" value="20" placeholder="æœ€å°%">
          <input type="number" id="profitMax" placeholder="æœ€å¤§%">
        </label>

        <label>é”€å”®èŠ‚å¥ï¼š
          <select id="salesSpeed">
            <option value="çŸ­æœŸçˆ†é‡">â¶ çŸ­æœŸçˆ†é‡</option>
            <option value="é•¿æœŸç¨³å®š" selected>â· é•¿æœŸç¨³å®š</option>
          </select>
        </label>

        <label>åå¥½ç±»ç›®ï¼ˆå¯å¤šé€‰ï¼‰ï¼š
          <select id="category" multiple size="5">
            <option value="å®¶å±…" selected>å®¶å±…</option>
            <option value="å® ç‰©">å® ç‰©</option>
            <option value="å¨æˆ¿">å¨æˆ¿</option>
            <option value="æ•°ç ">æ•°ç </option>
            <option value="æˆ·å¤–">æˆ·å¤–</option>
          </select>
        </label>

        <label>ä»“å‚¨å’Œå‘è´§æ–¹å¼ï¼š
          <select id="shipping">
            <option value="FBA">â¶ FBA</option>
            <option value="è‡ªå‘è´§" selected>â· è‡ªå‘è´§</option>
            <option value="æµ·å¤–ä»“">â¸ æµ·å¤–ä»“</option>
          </select>
        </label>

        <label>ç»“åˆç¤¾åª’è¶‹åŠ¿åˆ¤æ–­ï¼š
          <select id="social">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </label>

        <button type="button" onclick="sendForm()">å‘é€</button>
      </form>
    </div>

    <div id="uploadPage" style="display: none;">
      <h2>ğŸ“Š æ‰¹é‡ä¸Šä¼ çŸ¥è¯†æ•°æ®ï¼ˆExcelï¼‰</h2>
      <input type="file" id="excelInput" accept=".xlsx, .xls" />
      <div id="log" style="white-space: pre-wrap; margin-top: 10px; color: green;"></div>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://divine-silence-bb95.zhangyabin2000618.workers.dev/";

    function switchPage(page) {
      document.getElementById("formPage").style.display = (page === 'form') ? 'block' : 'none';
      document.getElementById("uploadPage").style.display = (page === 'upload') ? 'block' : 'none';
    }

    function sendForm() {
      const message = `
é”€å”®ç«™ç‚¹ï¼š${document.getElementById("market").value}
æˆæœ¬èŒƒå›´ï¼š$${document.getElementById("costMin").value} ~ $${document.getElementById("costMax").value}
åˆ©æ¶¦ç‡èŒƒå›´ï¼š${document.getElementById("profitMin").value}% ~ ${document.getElementById("profitMax").value || "æœªå¡«"}%
é”€å”®èŠ‚å¥ï¼š${document.getElementById("salesSpeed").value}
åå¥½ç±»ç›®ï¼š${[...document.getElementById("category").selectedOptions].map(o => o.value).join(", ")}
ä»“å‚¨æ–¹å¼ï¼š${document.getElementById("shipping").value}
ç¤¾åª’è¶‹åŠ¿åˆ¤æ–­ï¼š${document.getElementById("social").value}
`;

      fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      })
        .then(res => res.json())
        .then(data => {
          const box = document.getElementById("chatBox");
          box.innerText = data.reply || data.error || "æ— å“åº”";
        })
        .catch(err => {
          document.getElementById("chatBox").innerText = "âŒ è¯·æ±‚å‡ºé”™ï¼š" + err.message;
        });
    }

    // âœ… Excel ä¸Šä¼ é€»è¾‘ï¼ˆå¸¦é”™è¯¯æ•æ‰ + çŠ¶æ€æç¤ºï¼‰
    document.getElementById("excelInput").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      const log = document.getElementById("log");
      log.style.color = "#000";
      log.textContent = "";

      if (!file) {
        log.style.color = "red";
        log.textContent = "âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶";
        return;
      }

      log.textContent = "ğŸ“¤ æ­£åœ¨è§£æå¹¶ä¸Šä¼ ï¼Œè¯·ç¨å€™...\n";

      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          // Using header: 1 to get an array of arrays, then manually handle column names.
          // IMPORTANT: If your first row is the header, you should use `rows[0]` for `headers`.
          // If your *second* row is the header, then `rows[1]` is correct.
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (!rows || rows.length <= 1) { // Checks if there's at least a header row + one data row
            log.style.color = "red";
            log.textContent += "âŒ è¡¨æ ¼ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¡Œã€‚\n";
            return;
          }

          // Get headers. Assuming the first row (index 0) is the actual header row.
          const headers = rows[0]; // Changed from rows[1] to rows[0] based on standard Excel format
          const uploadResults = [];
          let successCount = 0;

          // Start iterating from the first data row (index 1), skipping the header row
          for (let i = 1; i < rows.length; i++) {
            const rowData = rows[i];
            const rowText = rowData.join(" | ").trim(); // Keep original row text for vectorization

            if (!rowText) {
              uploadResults.push(`âš ï¸ ç¬¬ ${i} è¡Œæ•°æ®ä¸ºç©ºï¼Œè·³è¿‡`);
              continue;
            }

            // Map row data to Weaviate properties
            const weaviateProperties = {};
            // Iterate through headers, mapping data to corresponding property names
            headers.forEach((header, index) => {
              let value = rowData[index];
              const weaviatePropertyName = mapHeaderToWeaviateProperty(header); // Get the cleaned property name

              // Skip if the property name is invalid or empty after mapping
              if (!weaviatePropertyName) {
                  console.warn(`Skipping column '${header}' as its mapped Weaviate property name is invalid or empty.`);
                  return; // Skip this iteration of forEach
              }

              // Type conversion based on the *cleaned* Weaviate property name
              switch (weaviatePropertyName) {
                case "weeklySearchVolume":
                case "currentRank":
                case "impressions":
                case "clicks":
                case "spr":
                case "titleDensity":
                  weaviateProperties[weaviatePropertyName] = parseInt(value) || 0; // Convert to integer, 0 if invalid
                  break;
                case "ppcPrice":
                  weaviateProperties[weaviatePropertyName] = parseFloat(String(value || '').replace('$', '')) || 0.0; // Remove '$' and convert to float
                  break;
                default:
                  weaviateProperties[weaviatePropertyName] = String(value || ''); // Ensure it's a string
              }
            });

            // Add original row content as the main content for vectorization
            weaviateProperties.fullRowContent = rowText;

            try {
              const res = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  action: "upload",
                  content: rowText, // Still send original row text for worker to generate vector
                  source: file.name,
                  category: weaviateProperties.category || sheetName, // Use parsed category, else sheetName
                  properties: weaviateProperties // New: Send structured property data
                })
              });

              const result = await res.json();

              if (!res.ok || result.error) {
                uploadResults.push(`âŒ ç¬¬ ${i} è¡Œä¸Šä¼ å¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`);
              } else {
                uploadResults.push(`âœ… ç¬¬ ${i} è¡Œä¸Šä¼ æˆåŠŸ`);
                successCount++;
              }
            } catch (err) {
              uploadResults.push(`âŒ ç¬¬ ${i} è¡Œè¯·æ±‚å¼‚å¸¸ï¼š${err.message}`);
            }
          }

          log.innerHTML = `
            ğŸ“¦ æ–‡ä»¶åï¼š${file.name}
            ğŸ“‘ è¡¨æ ¼è¡Œæ•°ï¼š${rows.length - 1}
            âœ… æˆåŠŸä¸Šä¼ ï¼š${successCount}
            âŒ å¤±è´¥è¡Œæ•°ï¼š${rows.length - 1 - successCount}
            \n\n${uploadResults.join("\n")}
          `.trim();

          log.scrollIntoView({ behavior: "smooth" });

        } catch (err) {
          log.style.color = "red";
          log.textContent = `âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š${err.message}`;
        }
      };

      reader.onerror = () => {
        log.style.color = "red";
        log.textContent = "âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•";
      };

      reader.readAsArrayBuffer(file);
    });

    // âœ… Helper function: map Excel header to a valid Weaviate property name
    // This is the robust version that handles Chinese characters and GraphQL naming rules.
    function mapHeaderToWeaviateProperty(header) {
      const trimmedHeader = header.trim();

      switch (trimmedHeader) {
        case "å…³é”®è¯": return "keyword";
        case "å…³é”®è¯ç¿»è¯‘": return "keywordTranslation";
        case "å‘¨æœç´¢é‡": return "weeklySearchVolume";
        case "ç°æ’å": return "currentRank";
        case "å†å²æ’å": return "historyRank";
        case "å‘¨å˜åŒ–é‡": return "weeklyChangeAmount";
        case "å‘¨å˜åŒ–ç‡": return "weeklyChangeRate";
        case "PPCä»·æ ¼": return "ppcPrice";
        case "å»ºè®®ç«ä»·èŒƒå›´": return "suggestedBidRange";
        case "å±•ç¤ºé‡": return "impressions";
        case "ç‚¹å‡»é‡": return "clicks";
        case "SPR": return "spr";
        case "æ ‡é¢˜å¯†åº¦": return "titleDensity";
        case "ç‚¹å‡»é›†ä¸­åº¦": return "clickConcentration";
        case "è½¬åŒ–é›†ä¸­åº¦": return "conversionConcentration";
        case "ç‚¹å‡»å‰ä¸‰ASIN": return "top3Asin";
        case "ç‚¹å‡»å‰ä¸‰å“ç‰Œ": return "top3Brand";
        case "æ‰€å±ç±»ç›®": return "category";
        case "å®Œæ•´è¡Œå†…å®¹": return "fullRowContent";
        case "æ¥æº": return "source";
        default:
          // Fallback for unexpected headers: clean aggressively
          let cleanedName = trimmedHeader
            .replace(/[^\w\s]/g, '') // Remove non-word characters (includes punctuation, special symbols)
            .replace(/\s+/g, '_')   // Replace spaces with underscores
            .replace(/^_|_$/g, '')  // Remove leading/trailing underscores from replacements
            .toLowerCase();         // Convert to lower case for consistency

          // Prepend underscore if it starts with a number
          if (/^\d/.test(cleanedName)) {
            cleanedName = '_' + cleanedName;
          }

          // Ensure it's not empty and starts with a letter/underscore
          if (cleanedName.length === 0) {
            console.warn(`Original header '${header}' resulted in an empty property name.`);
            return null; // Indicate invalid property name
          }
          if (!/^[a-z_]/.test(cleanedName)) {
            cleanedName = '_' + cleanedName;
          }
          return cleanedName;
      }
    }
  </script>
</body>
</html>