<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>GMé€‰å“åŠ©æ‰‹</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>GMé€‰å“åŠ©æ‰‹</h1>

    <!-- âœ… é¡µé¢å¯¼èˆªæŒ‰é’® -->
    <div style="margin-bottom: 20px;">
      <button onclick="switchPage('form')">é€‰å“é—®ç­”</button>
      <button onclick="switchPage('upload')">ä¸Šä¼  Excel</button>
    </div>

    <!-- âœ… é¡µé¢åŒºåŸŸï¼šé€‰å“è¡¨å• -->
    <div id="formPage" style="display: block;">
      <div class="chat-box" id="chatBox"></div>

      <form id="selectionForm">
        <label>é”€å”®ç«™ç‚¹ï¼š
          <select id="market">
            <option value="ç¾å›½" selected>ğŸ‡ºğŸ‡¸ ç¾å›½</option>
            <option value="æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
            <option value="å¾·å›½">ğŸ‡©ğŸ‡ª å¾·å›½</option>
          </select>
        </label>

        <label>å•å“é‡‡è´­æˆæœ¬èŒƒå›´ï¼ˆç¾å…ƒï¼‰ï¼š
          <input type="number" id="costMin" value="50" placeholder="æœ€å°å€¼">
          <input type="number" id="costMax" value="100" placeholder="æœ€å¤§å€¼">
        </label>

        <label>æœŸæœ›åˆ©æ¶¦ç‡èŒƒå›´ï¼ˆ%ï¼‰ï¼š
          <input type="number" id="profitMin" value="20" placeholder="æœ€å°%">
          <input type="number" id="profitMax" placeholder="æœ€å¤§%">
        </label>

        <label>é”€å”®èŠ‚å¥ï¼š
          <select id="salesSpeed">
            <option value="çŸ­æœŸçˆ†é‡">â¶ çŸ­æœŸçˆ†é‡</option>
            <option value="é•¿æœŸç¨³å®š" selected>â· é•¿æœŸç¨³å®š</option>
          </select>
        </label>

        <label>åå¥½ç±»ç›®ï¼ˆå¯å¤šé€‰ï¼‰ï¼š
          <select id="category" multiple size="5">
            <option value="å®¶å±…" selected>å®¶å±…</option>
            <option value="å® ç‰©">å® ç‰©</option>
            <option value="å¨æˆ¿">å¨æˆ¿</option>
            <option value="æ•°ç ">æ•°ç </option>
            <option value="æˆ·å¤–">æˆ·å¤–</option>
          </select>
        </label>

        <label>ä»“å‚¨å’Œå‘è´§æ–¹å¼ï¼š
          <select id="shipping">
            <option value="FBA">â¶ FBA</option>
            <option value="è‡ªå‘è´§" selected>â· è‡ªå‘è´§</option>
            <option value="æµ·å¤–ä»“">â¸ æµ·å¤–ä»“</option>
          </select>
        </label>

        <label>ç»“åˆç¤¾åª’è¶‹åŠ¿åˆ¤æ–­ï¼š
          <select id="social">
            <option value="æ˜¯" selected>æ˜¯</option>
            <option value="å¦">å¦</option>
          </select>
        </label>

        <button type="button" onclick="sendForm()">å‘é€</button>
      </form>
    </div>

    <!-- âœ… é¡µé¢åŒºåŸŸï¼šä¸Šä¼  Excel -->
    <div id="uploadPage" style="display: none;">
      <h2>ğŸ“Š æ‰¹é‡ä¸Šä¼ çŸ¥è¯†æ•°æ®ï¼ˆExcelï¼‰</h2>
      <input type="file" id="excelInput" accept=".xlsx, .xls" />
      <div id="log" style="white-space: pre-wrap; margin-top: 10px; color: green;"></div>
    </div>
  </div>
<script>
  const WORKER_URL = "https://divine-silence-bb95.zhangyabin2000618.workers.dev/";

  function switchPage(page) {
    document.getElementById("formPage").style.display = (page === 'form') ? 'block' : 'none';
    document.getElementById("uploadPage").style.display = (page === 'upload') ? 'block' : 'none';
  }

  function sendForm() {
    const message = `
é”€å”®ç«™ç‚¹ï¼š${document.getElementById("market").value}
æˆæœ¬èŒƒå›´ï¼š$${document.getElementById("costMin").value} ~ $${document.getElementById("costMax").value}
åˆ©æ¶¦ç‡èŒƒå›´ï¼š${document.getElementById("profitMin").value}% ~ ${document.getElementById("profitMax").value || "æœªå¡«"}%
é”€å”®èŠ‚å¥ï¼š${document.getElementById("salesSpeed").value}
åå¥½ç±»ç›®ï¼š${[...document.getElementById("category").selectedOptions].map(o => o.value).join(", ")}
ä»“å‚¨æ–¹å¼ï¼š${document.getElementById("shipping").value}
ç¤¾åª’è¶‹åŠ¿åˆ¤æ–­ï¼š${document.getElementById("social").value}
`;

    fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    })
      .then(res => res.json())
      .then(data => {
        const box = document.getElementById("chatBox");
        box.innerText = data.reply || data.error || "æ— å“åº”";
      })
      .catch(err => {
        document.getElementById("chatBox").innerText = "âŒ è¯·æ±‚å‡ºé”™ï¼š" + err.message;
      });
  }

  // âœ… Excel ä¸Šä¼ é€»è¾‘ï¼ˆå¸¦é”™è¯¯æ•æ‰ + çŠ¶æ€æç¤ºï¼‰
  document.getElementById("excelInput").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    const log = document.getElementById("log");
    log.style.color = "#000";
    log.textContent = "";

    if (!file) {
      log.style.color = "red";
      log.textContent = "âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶";
      return;
    }

    log.textContent = "ğŸ“¤ æ­£åœ¨è§£æå¹¶ä¸Šä¼ ï¼Œè¯·ç¨å€™...\n";

    const reader = new FileReader();

    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        // ä½¿ç”¨ header: 1 è·å–æ•°ç»„çš„æ•°ç»„å½¢å¼ï¼Œç„¶åæ‰‹åŠ¨å¤„ç†åˆ—å
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (!rows || rows.length <= 1) {
          log.style.color = "red";
          log.textContent += "âŒ è¡¨æ ¼ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¡Œã€‚\n";
          return;
        }

        // è·å–è¡¨å¤´ï¼Œå‡è®¾ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´
        const headers = rows[1];
        const uploadResults = [];
        let successCount = 0;

        for (let i = 1; i < rows.length; i++) {
          const rowData = rows[i];
          const rowText = rowData.join(" | ").trim(); // ä¿æŒç”¨äºå‘é‡åŒ–çš„åŸå§‹è¡Œæ–‡æœ¬

          if (!rowText) {
            uploadResults.push(`âš ï¸ ç¬¬ ${i} è¡Œæ•°æ®ä¸ºç©ºï¼Œè·³è¿‡`);
            continue;
          }

          // å°†è¡Œæ•°æ®æ˜ å°„åˆ° Weaviate å±æ€§
          const weaviateProperties = {};
          // éå†è¡¨å¤´ï¼Œå°†æ•°æ®æ˜ å°„åˆ°å¯¹åº”çš„å±æ€§å
          headers.forEach((header, index) => {
            let value = rowData[index];
            // å¯¹ä¸€äº›ç‰¹å®šçš„åˆ—è¿›è¡Œæ•°æ®ç±»å‹è½¬æ¢æˆ–æ¸…æ´—
            switch (header.trim()) { // ä½¿ç”¨ trim() ç¡®ä¿åŒ¹é…
              case "å‘¨æœç´¢é‡":
              case "ç°æ’å":
              case "å±•ç¤ºé‡":
              case "ç‚¹å‡»é‡":
              case "SPR":
              case "æ ‡é¢˜å¯†åº¦":
                weaviateProperties[mapHeaderToWeaviateProperty(header)] = parseInt(value) || 0; // è½¬æ¢ä¸ºæ•´æ•°ï¼Œå¦‚æœæ— æ•ˆåˆ™ä¸º0
                break;
              case "PPCä»·æ ¼":
                weaviateProperties[mapHeaderToWeaviateProperty(header)] = parseFloat(String(value).replace('$', '')) || 0.0; // ç§»é™¤'$'å¹¶è½¬æ¢ä¸ºæµ®ç‚¹æ•°
                break;
              default:
                weaviateProperties[mapHeaderToWeaviateProperty(header)] = String(value || ''); // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
            }
          });

          // æ·»åŠ åŸå§‹è¡Œå†…å®¹ä½œä¸ºå‘é‡åŒ–çš„ä¸»è¦å†…å®¹
          weaviateProperties.fullRowContent = rowText;

          try {
            const res = await fetch(WORKER_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "upload",
                content: rowText, // ä»ç„¶å‘é€åŸå§‹è¡Œæ–‡æœ¬ç»™Workerç”Ÿæˆå‘é‡
                source: file.name,
                category: weaviateProperties.category || sheetName, // ä½¿ç”¨è§£æå‡ºçš„ç±»ç›®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨sheetName
                properties: weaviateProperties // æ–°å¢ï¼šå‘é€ç»“æ„åŒ–çš„å±æ€§æ•°æ®
              })
            });

            const result = await res.json();

            if (!res.ok || result.error) {
              uploadResults.push(`âŒ ç¬¬ ${i} è¡Œä¸Šä¼ å¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`);
            } else {
              uploadResults.push(`âœ… ç¬¬ ${i} è¡Œä¸Šä¼ æˆåŠŸ`);
              successCount++;
            }
          } catch (err) {
            uploadResults.push(`âŒ ç¬¬ ${i} è¡Œè¯·æ±‚å¼‚å¸¸ï¼š${err.message}`);
          }
        }

        log.innerHTML = `
          ğŸ“¦ æ–‡ä»¶åï¼š${file.name}
          ğŸ“‘ è¡¨æ ¼è¡Œæ•°ï¼š${rows.length - 1}
          âœ… æˆåŠŸä¸Šä¼ ï¼š${successCount}
          âŒ å¤±è´¥è¡Œæ•°ï¼š${rows.length - 1 - successCount}
          \n\n${uploadResults.join("\n")}
        `.trim();

        log.scrollIntoView({ behavior: "smooth" });

      } catch (err) {
        log.style.color = "red";
        log.textContent = `âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š${err.message}`;
      }
    };

    reader.onerror = () => {
      log.style.color = "red";
      log.textContent = "âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•";
    };

    reader.readAsArrayBuffer(file);
  });

  // è¾…åŠ©å‡½æ•°ï¼šå°† Excel è¡¨å¤´æ˜ å°„åˆ° Weaviate å±æ€§å
  function mapHeaderToWeaviateProperty(header) {
    switch (header.trim()) {
      case "å…³é”®è¯": return "keyword";
      case "å…³é”®è¯ç¿»è¯‘": return "keywordTranslation";
      case "å‘¨æœç´¢é‡": return "weeklySearchVolume";
      case "ç°æ’å": return "currentRank";
      case "å†å²æ’å": return "historyRank";
      case "å‘¨å˜åŒ–é‡": return "weeklyChangeAmount";
      case "å‘¨å˜åŒ–ç‡": return "weeklyChangeRate";
      case "PPCä»·æ ¼": return "ppcPrice";
      case "å»ºè®®ç«ä»·èŒƒå›´": return "suggestedBidRange";
      case "å±•ç¤ºé‡": return "impressions";
      case "ç‚¹å‡»é‡": return "clicks";
      case "SPR": return "spr";
      case "æ ‡é¢˜å¯†åº¦": return "titleDensity";
      case "ç‚¹å‡»é›†ä¸­åº¦": return "clickConcentration";
      case "è½¬åŒ–é›†ä¸­åº¦": return "conversionConcentration";
      case "ç‚¹å‡»å‰ä¸‰ASIN": return "top3Asin";
      case "ç‚¹å‡»å‰ä¸‰å“ç‰Œ": return "top3Brand";
      case "æ‰€å±ç±»ç›®": return "category"; // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† 'category'
      default: return header.trim().replace(/\s+/g, ''); // ç§»é™¤ç©ºæ ¼ä½œä¸ºé»˜è®¤å±æ€§å
    }
  }
</script>

</body>
</html>
